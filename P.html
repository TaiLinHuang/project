<!DOCTYPE html>
<html>
<head>
<style>
.checkbox {
  position: absolute;
  left: -999em;
}

.check {
  border: solid 5px #fff;
  z-index: -1;
}

.checkbox:checked ~ .check {
  border-color: #d00;
}

</style>
</head>

<body>

<div>
  <p id="loading-opencv-msg">Loading the Opencv ...</p>
</div>

<div class="row-align">
  <table>
    <tr>
      <td><input type="file" id="file-upload1" /></td>
      <td><img id="src-image1" /></td>
      <td><input type="file" id="file-upload2" /></td>
      <td><img id="src-image2" /></td>
    </tr>
    <tr>
      <td>
        <label for="quantity">加密生成(2~16)
          <input type="number" id="quantity" name="quantity" min="2" max="16">
          張</label>
        <button id="button1" onclick="showphotos()">生成</button>
      </td>
    </tr>
    <tr>
      <td><label for="box1"><input id="box1" type="checkbox" class="checkbox" value='1'>
          <div class="check"><canvas id="canvas1" /></div>
        </label></td>
      <td><label for="box2"><input id="box2" type="checkbox" class="checkbox" value='2'>
          <div class="check"><canvas id="canvas2" /></div>
        </label></td>
      <td><label for="box3"><input id="box3" type="checkbox" class="checkbox" value='3'>
          <div class="check"><canvas id="canvas3" /></div>
        </label></td>
      <td><label for="box4"><input id="box4" type="checkbox" class="checkbox" value='4'>
          <div class="check"><canvas id="canvas4" /></div>
        </label></td>
      <td><label for="box5"><input id="box5" type="checkbox" class="checkbox" value='5'>
          <div class="check"><canvas id="canvas5" /></div>
        </label></td>
      <td><label for="box6"><input id="box6" type="checkbox" class="checkbox" value='6'>
          <div class="check"><canvas id="canvas6" /></div>
        </label></td>
      <td><label for="box7"><input id="box7" type="checkbox" class="checkbox" value='7'>
          <div class="check"><canvas id="canvas7" /></div>
        </label></td>
      <td><label for="box8"><input id="box8" type="checkbox" class="checkbox" value='8'>
          <div class="check"><canvas id="canvas8" /></div>
        </label></td>
    </tr>
    <tr>
      <td><label for="box9"><input id="box9" type="checkbox" class="checkbox" value='9'>
          <div class="check"><canvas id="canvas9" /></div>
        </label></td>
      <td><label for="box10"><input id="box10" type="checkbox" class="checkbox" value='10'>
          <div class="check"><canvas id="canvas10" /></div>
        </label></td>
      <td><label for="box11"><input id="box11" type="checkbox" class="checkbox" value='11'>
          <div class="check"><canvas id="canvas11" /></div>
        </label></td>
      <td><label for="box12"><input id="box12" type="checkbox" class="checkbox" value='12'>
          <div class="check"><canvas id="canvas12" /></div>
        </label></td>
      <td><label for="box13"><input id="box13" type="checkbox" class="checkbox" value='13'>
          <div class="check"><canvas id="canvas13" /></div>
        </label></td>
      <td><label for="box14"><input id="box14" type="checkbox" class="checkbox" value='14'>
          <div class="check"><canvas id="canvas14" /></div>
        </label></td>
      <td><label for="box15"><input id="box15" type="checkbox" class="checkbox" value='15'>
          <div class="check"><canvas id="canvas15" /></div>
        </label></td>
      <td><label for="box16"><input id="box16" type="checkbox" class="checkbox" value='16'>
          <div class="check"><canvas id="canvas16" /></div>
        </label></td>
    </tr>
    <tr>
      <td><button id="button2" onclick="showphoto()">解密</button>
        <label id="err"></label></td>
    </tr>
    <tr>
      <td><canvas id="canvas" /></td>
    </tr>
    <tr>
      <td><button id="button3" onclick="check()">比對</button>
        <label id="check"></label></td>
    </tr>
  </table>
</div>

<script>
var fileUploadEl = document.getElementById('file-upload1'),
  srcImgEl = document.getElementById('src-image1')
fileUploadEl.addEventListener("change", function(e) {
  srcImgEl.src = URL.createObjectURL(e.target.files[0]);
}, false);

var fileUploadE2 = document.getElementById('file-upload2'),
  srcImgE2 = document.getElementById('src-image2')
fileUploadE2.addEventListener("change", function(e) {
  srcImgE2.src = URL.createObjectURL(e.target.files[0]);
}, false);
//var s1 = [],s2 = [],c1 = [],c2 = [],cRows = 0,cCols = 0;
var s1 = [],s2 = [],c1 = [],c2 = [],cRows = 0,cCols = 0;

srcImgEl.onload = function() {
  var src1 = cv.imread(srcImgEl);
  s1 = getpixels(src1);
}

srcImgE2.onload = function() {
  var src2 = cv.imread(srcImgE2);
  cRows = src2.rows;
  cCols = src2.cols;
  c1 = getpixels(src2);
}

function getpixels(src) {
  var p = [];
  for (var y = 0; y < src.rows; y++) {
    for (var x = 0; x < src.cols; x++) {
      var rgb = src.ucharPtr(y, x);
      for (var t = 0; t < 4; t++)
        p[y * src.cols * 4 + x * 4 + t] = rgb[t];
    }
  }
  return p;
}

function xorpixels() {
  for (var i = 0; i < s1.length; i += 4) {
    var y = Math.floor(i / (cCols / 2 * 4)),
      x = Math.floor((i % (cCols / 2 * 4)) / 4);
    for (var n = 0; n < 4; n++) {
      for (var t = 0; t < 4; t++)
        s2[(2 * y + Math.floor(n / 2)) * (cCols * 4) + (2 * x + (n % 2)) * 4 + t] = s1[i + t];
    }
  }
  for (var i = 0; i < s2.length; i++) {
    if (i % 4 == 3) {
      c2[i] = 255;
      continue;
    }
    c2[i] = s2[i] ^ c1[i];
  }
}

function getphotos() {
  xorpixels();
  var i = document.getElementById('quantity');
  //var photos = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];
  var photos = [[],[],[],[],[],[],[],[],[],[],[],[],[],[],[],[]];
  for (var y = 0; y < cRows; y += 2) {
    for (var x = 0; x < cCols; x += 2) {
      var times = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
      for (var p = 0; p < i.value; p++) {
        var num = Math.floor(Math.random() * 16);
        while (times[num]) {
          num = Math.floor(Math.random() * 16);
        }
        for (var n = 0; n < 4; n++) {
          for (var t = 0; t < 4; t++) {
            if (Math.floor(num / Math.pow(2, (3 - n))) % 2 == 0)
              photos[p][(y + Math.floor(n / 2)) * cCols * 4 + (x + (n % 2)) * 4 + t] = c1[(y + Math.floor(n / 2)) * cCols * 4 + (x + (n % 2)) * 4 + t];
            else
              photos[p][(y + Math.floor(n / 2)) * cCols * 4 + (x + (n % 2)) * 4 + t] = c2[(y + Math.floor(n / 2)) * cCols * 4 + (x + (n % 2)) * 4 + t];
          }
        }
        times[num]++;
      }
    }
  }
  return photos;
}

function showphotos() {
  var n = document.getElementById('quantity');
  var tmp = getphotos();
  for (var p = 1; p <= n.value; p++) {
    var c = document.getElementById('canvas' + p),
      ctx = c.getContext('2d'),
      imgData = ctx.createImageData(cRows, cCols);
    c.width = cCols;
    c.height = cRows;
    for (var i = 0; i < imgData.data.length; i++)
      imgData.data[i] = tmp[p - 1][i];
    ctx.putImageData(imgData, 0, 0);
  }
}

function showphoto() {
  var a = -1,b = -1;
  var markedCheckbox = document.querySelectorAll('input[type="checkbox"]:checked');
  for (var checkbox of markedCheckbox) {
    if (a == -1) a = checkbox.value;
    else b = checkbox.value;
  }
  var c1 = document.getElementById('canvas' + a),
      c2 = document.getElementById('canvas' + b),
      c = document.getElementById('canvas'),
      ctx1 = c1.getContext('2d'),
      ctx2 = c2.getContext('2d'),
      ctx = c.getContext('2d'),
      imgData1 = ctx1.getImageData(0, 0, cCols, cRows),
      imgData2 = ctx2.getImageData(0, 0, cCols, cRows),
      imgData = ctx.createImageData(cRows / 2, cCols / 2),
      tmp = [];
    c.width = cCols / 2;
    c.height = cRows / 2;
  if (a != -1 && b != -1) {  
    for (let i = 0; i < imgData1.data.length; i++) {
      if (i % 4 == 3) {
        tmp[i] = 255;
        continue;
      }
      tmp[i] = imgData1.data[i] ^ imgData2.data[i];
    }
    for (var y = 0; y < cRows / 2; y++) {
      for (var x = 0; x < cCols / 2; x++) {
        for (var t = 0; t < 4; t++)
          imgData.data[y * (cCols / 2) * 4 + x * 4 + t] = Math.max(tmp[2 * y * cCols * 4 + 2 * x * 4 + t], tmp[2 * y * cCols * 4 + (2 * x + 1) * 4 + t], tmp[(2 * y + 1) * cCols * 4 + 2 * x * 4 + t], tmp[(2 * y + 1) * cCols * 4 + (2 * x + 1) * 4 + t])
      }
    }
    ctx.putImageData(imgData, 0, 0);
  } else {
   document.getElementById("err").innerHTML = ('請選擇兩張圖片');
   for (let i = 0; i < imgData.data.length; i++) {
      if (i % 4 == 3) {
        tmp[i] = 255;
        continue;
      }
      tmp[i] = 0;
    }
    ctx.putImageData(imgData, 0, 0);
  }
}

function check() {
  var c = document.getElementById('canvas'),
    ctx = c.getContext('2d'),
    imgData = ctx.getImageData(0, 0, cCols / 2, cRows / 2),
    n = 0;
  for (let i = 0; i < imgData.data.length; i++) {
    if (imgData.data[i] == s1[i])
      n++;
  }
  document.getElementById("check").innerHTML = ('與原圖' + n / imgData.data.length * 100 + '%相符');
}

window.onOpenCvReady = function() {
  document.getElementById('loading-opencv-msg').remove();
}

</script>
</body>

</html>